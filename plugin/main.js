var p=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var v=(o,i)=>{for(var e in i)p(o,e,{get:i[e],enumerable:!0})},P=(o,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of F(i))!w.call(o,s)&&s!==e&&p(o,s,{get:()=>i[s],enumerable:!(t=m(i,s))||t.enumerable});return o};var y=o=>P(p({},"__esModule",{value:!0}),o);var x={};v(x,{default:()=>u});module.exports=y(x);var l=require("obsidian"),f={publicFolder:"PUBLIC",notesFolder:"Notes",attachmentsFolder:"Attachments",requiredFields:["categories"]},u=class extends l.Plugin{constructor(){super(...arguments);this.settings=f}async onload(){await this.loadSettings(),this.addCommand({id:"publish-to-knowledge-hub",name:"Publish to Knowledge Hub",callback:()=>this.openPublishModal()}),this.addCommand({id:"unpublish-current-file",name:"Unpublish current file",checkCallback:e=>{let t=this.app.workspace.getActiveFile();return!t||!t.path.startsWith(this.settings.publicFolder+"/")?!1:(e||this.unpublishFile(t),!0)}}),this.addSettingTab(new b(this.app,this)),console.log("Company Knowledge Hub plugin loaded")}onunload(){console.log("Company Knowledge Hub plugin unloaded")}async loadSettings(){this.settings=Object.assign({},f,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async findPublishableFiles(){let e=[],t=this.app.vault.getMarkdownFiles();for(let s of t){if(s.path.startsWith(this.settings.publicFolder+"/"))continue;let c=this.app.metadataCache.getFileCache(s),n=c==null?void 0:c.frontmatter;if(!n)continue;let r=n.isPublished;if(r!=="yes"&&r!==!0&&r!=="true")continue;let a=[];for(let d of this.settings.requiredFields){let h=n[d];(!h||Array.isArray(h)&&h.length===0)&&a.push(`Missing: ${d}`)}e.push({file:s,valid:a.length===0,errors:a})}return e}getEmbeddedAttachments(e){let t=[],s=this.app.metadataCache.getFileCache(e);if(!(s!=null&&s.embeds))return t;for(let c of s.embeds){let n=this.app.metadataCache.getFirstLinkpathDest(c.link,e.path);n instanceof l.TFile&&!n.extension.match(/md/)&&t.push(n)}return t}async publishFile(e){await this.ensureFolderExists(this.settings.publicFolder);let t=`${this.settings.publicFolder}/${this.settings.attachmentsFolder}`;await this.ensureFolderExists(t);let s=this.getEmbeddedAttachments(e);for(let n of s){if(n.path.startsWith(t))continue;let r=`${t}/${n.name}`;try{await this.app.fileManager.renameFile(n,r)}catch(a){console.error(`Failed to move attachment ${n.path}:`,a)}}await this.app.fileManager.processFrontMatter(e,n=>{n.publishDate=new Date().toISOString().split("T")[0]});let c=`${this.settings.publicFolder}/${e.name}`;await this.app.fileManager.renameFile(e,c)}async unpublishFile(e){await this.ensureFolderExists(this.settings.notesFolder),await this.app.fileManager.processFrontMatter(e,s=>{delete s.isPublished,delete s.publishDate});let t=`${this.settings.notesFolder}/${e.name}`;await this.app.fileManager.renameFile(e,t),new l.Notice(`Unpublished: ${e.basename}`)}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}async openPublishModal(){let e=await this.findPublishableFiles();if(e.length===0){new l.Notice("No files with isPublished: true found");return}new g(this.app,this,e).open()}},g=class extends l.Modal{constructor(i,e,t){super(i),this.plugin=e,this.results=t,this.selectedFiles=new Set(t.filter(s=>s.valid).map(s=>s.file))}onOpen(){let{contentEl:i}=this;i.empty(),i.addClass("knowledge-hub-modal"),i.createEl("h2",{text:"Publish to Knowledge Hub"});let e=this.results.filter(n=>n.valid),t=this.results.filter(n=>!n.valid);if(e.length>0){let n=i.createDiv("valid-section");n.createEl("h3",{text:`Ready to publish (${e.length} files)`});let r=n.createDiv("file-list");for(let a of e){let d=r.createDiv("file-item"),h=d.createEl("input",{type:"checkbox"});h.checked=this.selectedFiles.has(a.file),h.addEventListener("change",()=>{h.checked?this.selectedFiles.add(a.file):this.selectedFiles.delete(a.file),this.updateButtonText()}),d.createSpan({text:a.file.basename,cls:"file-name"})}}if(t.length>0){let n=i.createDiv("invalid-section");n.createEl("h3",{text:`Missing required frontmatter (${t.length} files)`,cls:"warning-header"});let r=n.createDiv("file-list");for(let a of t){let d=r.createDiv("file-item invalid");d.createSpan({text:a.file.basename,cls:"file-name"}),d.createSpan({text:` - ${a.errors.join(", ")}`,cls:"error-text"})}}let s=i.createDiv("button-container");s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),this.publishButton=s.createEl("button",{text:`Publish ${this.selectedFiles.size} files`,cls:"mod-cta"}),this.publishButton.addEventListener("click",()=>this.doPublish())}updateButtonText(){this.publishButton.textContent=`Publish ${this.selectedFiles.size} files`,this.publishButton.disabled=this.selectedFiles.size===0}async doPublish(){let i=Array.from(this.selectedFiles),e=0;for(let t of i)try{await this.plugin.publishFile(t),e++}catch(s){console.error(`Failed to publish ${t.path}:`,s),new l.Notice(`Failed to publish ${t.basename}`)}new l.Notice(`Published ${e} files to ${this.plugin.settings.publicFolder}`),this.close()}onClose(){let{contentEl:i}=this;i.empty()}},b=class extends l.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Company Knowledge Hub Settings"}),new l.Setting(i).setName("Public folder").setDesc("Folder where published files will be moved to").addText(e=>e.setPlaceholder("PUBLIC").setValue(this.plugin.settings.publicFolder).onChange(async t=>{this.plugin.settings.publicFolder=t||"PUBLIC",await this.plugin.saveSettings()})),new l.Setting(i).setName("Notes folder").setDesc("Folder where unpublished files will be moved to").addText(e=>e.setPlaceholder("Notes").setValue(this.plugin.settings.notesFolder).onChange(async t=>{this.plugin.settings.notesFolder=t||"Notes",await this.plugin.saveSettings()})),new l.Setting(i).setName("Attachments subfolder").setDesc("Subfolder within PUBLIC for images and attachments").addText(e=>e.setPlaceholder("Attachments").setValue(this.plugin.settings.attachmentsFolder).onChange(async t=>{this.plugin.settings.attachmentsFolder=t||"Attachments",await this.plugin.saveSettings()})),new l.Setting(i).setName("Required frontmatter fields").setDesc("Comma-separated list of fields required for publishing").addText(e=>e.setPlaceholder("categories").setValue(this.plugin.settings.requiredFields.join(", ")).onChange(async t=>{this.plugin.settings.requiredFields=t.split(",").map(s=>s.trim()).filter(s=>s.length>0),await this.plugin.saveSettings()}))}};
