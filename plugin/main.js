var p=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var v=(o,t)=>{for(var e in t)p(o,e,{get:t[e],enumerable:!0})},P=(o,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of m(t))!w.call(o,s)&&s!==e&&p(o,s,{get:()=>t[s],enumerable:!(i=F(t,s))||i.enumerable});return o};var y=o=>P(p({},"__esModule",{value:!0}),o);var x={};v(x,{default:()=>h});module.exports=y(x);var l=require("obsidian"),f={publicFolder:"PUBLIC",notesFolder:"Notes",requiredFields:["categories"]},h=class extends l.Plugin{constructor(){super(...arguments);this.settings=f}async onload(){await this.loadSettings(),this.addCommand({id:"publish-to-knowledge-hub",name:"Publish to Knowledge Hub",callback:()=>this.openPublishModal()}),this.addCommand({id:"unpublish-current-file",name:"Unpublish current file",checkCallback:e=>{let i=this.app.workspace.getActiveFile();return!i||!i.path.startsWith(this.settings.publicFolder+"/")?!1:(e||this.unpublishFile(i),!0)}}),this.addSettingTab(new b(this.app,this)),console.log("Company Knowledge Hub plugin loaded")}onunload(){console.log("Company Knowledge Hub plugin unloaded")}async loadSettings(){this.settings=Object.assign({},f,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async findPublishableFiles(){let e=[],i=this.app.vault.getMarkdownFiles();for(let s of i){if(s.path.startsWith(this.settings.publicFolder+"/"))continue;let u=this.app.metadataCache.getFileCache(s),n=u==null?void 0:u.frontmatter;if(!n)continue;let d=n.isPublished;if(d!=="yes"&&d!==!0&&d!=="true")continue;let a=[];for(let r of this.settings.requiredFields){let c=n[r];(!c||Array.isArray(c)&&c.length===0)&&a.push(`Missing: ${r}`)}e.push({file:s,valid:a.length===0,errors:a})}return e}async publishFile(e){await this.ensureFolderExists(this.settings.publicFolder),await this.app.fileManager.processFrontMatter(e,s=>{s.publishDate=new Date().toISOString().split("T")[0]});let i=`${this.settings.publicFolder}/${e.name}`;await this.app.fileManager.renameFile(e,i)}async unpublishFile(e){await this.ensureFolderExists(this.settings.notesFolder),await this.app.fileManager.processFrontMatter(e,s=>{delete s.isPublished,delete s.publishDate});let i=`${this.settings.notesFolder}/${e.name}`;await this.app.fileManager.renameFile(e,i),new l.Notice(`Unpublished: ${e.basename}`)}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}async openPublishModal(){let e=await this.findPublishableFiles();if(e.length===0){new l.Notice("No files with isPublished: yes found");return}new g(this.app,this,e).open()}},g=class extends l.Modal{constructor(t,e,i){super(t),this.plugin=e,this.results=i,this.selectedFiles=new Set(i.filter(s=>s.valid).map(s=>s.file))}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("knowledge-hub-modal"),t.createEl("h2",{text:"Publish to Knowledge Hub"});let e=this.results.filter(n=>n.valid),i=this.results.filter(n=>!n.valid);if(e.length>0){let n=t.createDiv("valid-section");n.createEl("h3",{text:`Ready to publish (${e.length} files)`});let d=n.createDiv("file-list");for(let a of e){let r=d.createDiv("file-item"),c=r.createEl("input",{type:"checkbox"});c.checked=this.selectedFiles.has(a.file),c.addEventListener("change",()=>{c.checked?this.selectedFiles.add(a.file):this.selectedFiles.delete(a.file),this.updateButtonText()}),r.createSpan({text:a.file.basename,cls:"file-name"})}}if(i.length>0){let n=t.createDiv("invalid-section");n.createEl("h3",{text:`Missing required frontmatter (${i.length} files)`,cls:"warning-header"});let d=n.createDiv("file-list");for(let a of i){let r=d.createDiv("file-item invalid");r.createSpan({text:a.file.basename,cls:"file-name"}),r.createSpan({text:` - ${a.errors.join(", ")}`,cls:"error-text"})}}let s=t.createDiv("button-container");s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),this.publishButton=s.createEl("button",{text:`Publish ${this.selectedFiles.size} files`,cls:"mod-cta"}),this.publishButton.addEventListener("click",()=>this.doPublish())}updateButtonText(){this.publishButton.textContent=`Publish ${this.selectedFiles.size} files`,this.publishButton.disabled=this.selectedFiles.size===0}async doPublish(){let t=Array.from(this.selectedFiles),e=0;for(let i of t)try{await this.plugin.publishFile(i),e++}catch(s){console.error(`Failed to publish ${i.path}:`,s),new l.Notice(`Failed to publish ${i.basename}`)}new l.Notice(`Published ${e} files to ${this.plugin.settings.publicFolder}`),this.close()}onClose(){let{contentEl:t}=this;t.empty()}},b=class extends l.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Company Knowledge Hub Settings"}),new l.Setting(t).setName("Public folder").setDesc("Folder where published files will be moved to").addText(e=>e.setPlaceholder("PUBLIC").setValue(this.plugin.settings.publicFolder).onChange(async i=>{this.plugin.settings.publicFolder=i||"PUBLIC",await this.plugin.saveSettings()})),new l.Setting(t).setName("Notes folder").setDesc("Folder where unpublished files will be moved to").addText(e=>e.setPlaceholder("Notes").setValue(this.plugin.settings.notesFolder).onChange(async i=>{this.plugin.settings.notesFolder=i||"Notes",await this.plugin.saveSettings()})),new l.Setting(t).setName("Required frontmatter fields").setDesc("Comma-separated list of fields required for publishing").addText(e=>e.setPlaceholder("categories").setValue(this.plugin.settings.requiredFields.join(", ")).onChange(async i=>{this.plugin.settings.requiredFields=i.split(",").map(s=>s.trim()).filter(s=>s.length>0),await this.plugin.saveSettings()}))}};
