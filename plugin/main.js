var p=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var P=(a,i)=>{for(var e in i)p(a,e,{get:i[e],enumerable:!0})},y=(a,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of w(i))!v.call(a,t)&&t!==e&&p(a,t,{get:()=>i[t],enumerable:!(s=F(i,t))||s.enumerable});return a};var C=a=>y(p({},"__esModule",{value:!0}),a);var E={};P(E,{default:()=>u});module.exports=C(E);var l=require("obsidian"),m={publicFolder:"PUBLIC",notesFolder:"Notes",attachmentsFolder:"Attachments",requiredFields:["categories"]},S=/[\\:*?"<>|]/g;function x(a){if(!a||typeof a!="string")return!1;let i=a.trim();return!(i.includes("..")||i.startsWith("/")||i.startsWith("\\")||S.test(i)||i.length===0)}function g(a,i){return x(a)?a.trim():i}var u=class extends l.Plugin{constructor(){super(...arguments);this.settings=m}async onload(){await this.loadSettings(),this.addCommand({id:"publish-to-knowledge-hub",name:"Publish to Knowledge Hub",callback:()=>this.openPublishModal()}),this.addCommand({id:"unpublish-current-file",name:"Unpublish current file",checkCallback:e=>{let s=this.app.workspace.getActiveFile();return!s||!s.path.startsWith(this.settings.publicFolder+"/")?!1:(e||this.unpublishFile(s),!0)}}),this.addSettingTab(new b(this.app,this)),console.log("Company Knowledge Hub plugin loaded")}onunload(){console.log("Company Knowledge Hub plugin unloaded")}async loadSettings(){this.settings=Object.assign({},m,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async findPublishableFiles(){let e=[],s=this.app.vault.getMarkdownFiles();for(let t of s){if(t.path.startsWith(this.settings.publicFolder+"/"))continue;let c=this.app.metadataCache.getFileCache(t),n=c==null?void 0:c.frontmatter;if(!n)continue;let r=n.isPublished;if(r!=="yes"&&r!==!0&&r!=="true")continue;let o=[];for(let d of this.settings.requiredFields){let h=n[d];(!h||Array.isArray(h)&&h.length===0)&&o.push(`Missing: ${d}`)}e.push({file:t,valid:o.length===0,errors:o})}return e}getEmbeddedAttachments(e){let s=[],t=this.app.metadataCache.getFileCache(e);if(!(t!=null&&t.embeds))return s;for(let c of t.embeds){let n=this.app.metadataCache.getFirstLinkpathDest(c.link,e.path);n instanceof l.TFile&&!n.extension.match(/md/)&&s.push(n)}return s}async publishFile(e){await this.ensureFolderExists(this.settings.publicFolder);let s=`${this.settings.publicFolder}/${this.settings.attachmentsFolder}`;await this.ensureFolderExists(s);let t=this.getEmbeddedAttachments(e);for(let n of t){if(n.path.startsWith(s))continue;let r=`${s}/${n.name}`;try{await this.app.fileManager.renameFile(n,r)}catch(o){console.error(`Failed to move attachment ${n.path}:`,o)}}await this.app.fileManager.processFrontMatter(e,n=>{n.publishDate=new Date().toISOString().split("T")[0]});let c=`${this.settings.publicFolder}/${e.name}`;await this.app.fileManager.renameFile(e,c)}async unpublishFile(e){await this.ensureFolderExists(this.settings.notesFolder),await this.app.fileManager.processFrontMatter(e,t=>{delete t.isPublished,delete t.publishDate});let s=`${this.settings.notesFolder}/${e.name}`;await this.app.fileManager.renameFile(e,s),new l.Notice(`Unpublished: ${e.basename}`)}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}async openPublishModal(){let e=await this.findPublishableFiles();if(e.length===0){new l.Notice("No files with isPublished: true found");return}new f(this.app,this,e).open()}},f=class extends l.Modal{constructor(i,e,s){super(i),this.plugin=e,this.results=s,this.selectedFiles=new Set(s.filter(t=>t.valid).map(t=>t.file))}onOpen(){let{contentEl:i}=this;i.empty(),i.addClass("knowledge-hub-modal"),i.createEl("h2",{text:"Publish to Knowledge Hub"});let e=this.results.filter(n=>n.valid),s=this.results.filter(n=>!n.valid);if(e.length>0){let n=i.createDiv("valid-section");n.createEl("h3",{text:`Ready to publish (${e.length} files)`});let r=n.createDiv("file-list");for(let o of e){let d=r.createDiv("file-item"),h=d.createEl("input",{type:"checkbox"});h.checked=this.selectedFiles.has(o.file),h.addEventListener("change",()=>{h.checked?this.selectedFiles.add(o.file):this.selectedFiles.delete(o.file),this.updateButtonText()}),d.createSpan({text:o.file.basename,cls:"file-name"})}}if(s.length>0){let n=i.createDiv("invalid-section");n.createEl("h3",{text:`Missing required frontmatter (${s.length} files)`,cls:"warning-header"});let r=n.createDiv("file-list");for(let o of s){let d=r.createDiv("file-item invalid");d.createSpan({text:o.file.basename,cls:"file-name"}),d.createSpan({text:` - ${o.errors.join(", ")}`,cls:"error-text"})}}let t=i.createDiv("button-container");t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),this.publishButton=t.createEl("button",{text:`Publish ${this.selectedFiles.size} files`,cls:"mod-cta"}),this.publishButton.addEventListener("click",()=>this.doPublish())}updateButtonText(){this.publishButton.textContent=`Publish ${this.selectedFiles.size} files`,this.publishButton.disabled=this.selectedFiles.size===0}async doPublish(){let i=Array.from(this.selectedFiles),e=0;for(let s of i)try{await this.plugin.publishFile(s),e++}catch(t){console.error(`Failed to publish ${s.path}:`,t),new l.Notice(`Failed to publish ${s.basename}`)}new l.Notice(`Published ${e} files to ${this.plugin.settings.publicFolder}`),this.close()}onClose(){let{contentEl:i}=this;i.empty()}},b=class extends l.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Company Knowledge Hub Settings"}),new l.Setting(i).setName("Public folder").setDesc("Folder where published files will be moved to. No special characters or path traversal allowed.").addText(e=>e.setPlaceholder("PUBLIC").setValue(this.plugin.settings.publicFolder).onChange(async s=>{let t=g(s,"PUBLIC");this.plugin.settings.publicFolder=t,s!==t&&s.trim().length>0&&e.setValue(t),await this.plugin.saveSettings()})),new l.Setting(i).setName("Notes folder").setDesc("Folder where unpublished files will be moved to. No special characters or path traversal allowed.").addText(e=>e.setPlaceholder("Notes").setValue(this.plugin.settings.notesFolder).onChange(async s=>{let t=g(s,"Notes");this.plugin.settings.notesFolder=t,s!==t&&s.trim().length>0&&e.setValue(t),await this.plugin.saveSettings()})),new l.Setting(i).setName("Attachments subfolder").setDesc("Subfolder within PUBLIC for images and attachments. No special characters or path traversal allowed.").addText(e=>e.setPlaceholder("Attachments").setValue(this.plugin.settings.attachmentsFolder).onChange(async s=>{let t=g(s,"Attachments");this.plugin.settings.attachmentsFolder=t,s!==t&&s.trim().length>0&&e.setValue(t),await this.plugin.saveSettings()})),new l.Setting(i).setName("Required frontmatter fields").setDesc("Comma-separated list of fields required for publishing").addText(e=>e.setPlaceholder("categories").setValue(this.plugin.settings.requiredFields.join(", ")).onChange(async s=>{this.plugin.settings.requiredFields=s.split(",").map(t=>t.trim()).filter(t=>t.length>0),await this.plugin.saveSettings()}))}};
